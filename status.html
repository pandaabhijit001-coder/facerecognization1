<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Processing Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="container mt-5">

<h1>Processing your video...</h1>

<div>
    <p>Progress: <span id="progress">0</span>%</p>
    <div id="matches"></div>
    <div id="thumbnails" class="d-flex flex-wrap"></div>
    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">Back to Search</a>
</div>

<script>
    let taskId = "{{ task_id }}";

    function fetchProgress() {
        fetch(`/progress/${taskId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('progress').innerText = data.progress;

                if (data.done) {
                    if (data.matches.length > 0) {
                        const matchesDiv = document.getElementById('matches');
                        matchesDiv.innerHTML = `<p>Person found at timestamps (s): ${data.matches.join(', ')}</p>`;

                        // Fetch thumbnails
                        fetch(`/list_thumbnails/${taskId}`)
                            .then(res => res.json())
                            .then(files => {
                                const thumbsDiv = document.getElementById('thumbnails');
                                thumbsDiv.innerHTML = '<h3>Matching Faces:</h3>';
                                files.forEach(file => {
                                    let img = document.createElement('img');
                                    img.src = `/thumbnails/${file}`;
                                    img.width = 120;
                                    img.style.margin = '5px';
                                    img.classList.add('img-thumbnail');
                                    thumbsDiv.appendChild(img);
                                });
                            });
                    } else {
                        document.getElementById('matches').innerText = 'Person NOT found in the video.';
                    }
                } else {
                    setTimeout(fetchProgress, 3000);
                }
            })
            .catch(err => {
                console.error(err);
                setTimeout(fetchProgress, 5000);
            });
    }
    fetchProgress();
</script>

</body>
</html>
